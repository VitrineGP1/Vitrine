<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto - Vitrine</title>
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <style>
        body { padding-top: 120px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .product-details { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .product-image { width: 100%; max-width: 500px; border-radius: 10px; }
        .product-info h1 { margin-bottom: 15px; color: #333; }
        .product-price { font-size: 2rem; color: #28a745; font-weight: bold; margin: 20px 0; }
        .product-description { color: #666; line-height: 1.6; margin-bottom: 20px; }
        .product-meta { margin-bottom: 20px; }
        .meta-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .btn { padding: 15px 30px; background: #713112; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; margin: 5px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #2c4a6b; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .reviews-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .reviews-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .rating-summary { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .rating-average { font-size: 3rem; font-weight: bold; color: #333; }
        .rating-stars { color: #ffc107; font-size: 1.5rem; }
        .rating-count { color: #666; }
        .review-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .star-rating { display: flex; gap: 5px; margin-bottom: 15px; }
        .star { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
        .star:hover, .star.active { color: #ffc107; }
        .reviews-list { }
        .review-item { border-bottom: 1px solid #f0f0f0; padding: 20px 0; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .reviewer-name { font-weight: bold; }
        .review-date { color: #666; font-size: 0.9rem; }
        .review-rating { color: #ffc107; margin-bottom: 10px; }
        .review-comment { color: #333; line-height: 1.6; }
        .login-prompt { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; color: #666; }
        @media (max-width: 768px) {
            .product-details { grid-template-columns: 1fr; }
            .reviews-header { flex-direction: column; gap: 15px; }
            .rating-summary { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a class="logo" href="/"><img src="imagens/logo(2).png" width="75px" height="75px" alt="Logo da Vitrine"></a>
        <nav>
            <ul class="nav-list">
                <li><a href="/">Início</a></li>
                <li><a href="/produtos">Produtos</a></li>
                <li><a href="/carrinho">Carrinho</a></li>
                <li><a href="/perfil">Perfil</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section class="product-details">
            <figure>
                <img id="product-image" src="" alt="Produto" class="product-image">
            </figure>
            
            <section class="product-info">
                <h1 id="product-name">Carregando...</h1>
                <p class="product-price" id="product-price">R$ 0,00</p>
                <p class="product-description" id="product-description">Carregando descrição...</p>
                
                <section class="product-meta">
                    <article class="meta-item">
                        <span>Categoria:</span>
                        <span id="product-category">-</span>
                    </article>
                    <article class="meta-item">
                        <span>Vendedor:</span>
                        <span id="product-seller">-</span>
                    </article>
                    <article class="meta-item">
                        <span>Estoque:</span>
                        <span id="product-stock">-</span>
                    </article>
                </section>

                <section>
                    <button class="btn btn-success add-to-cart" id="add-to-cart-btn">
                        <i class="fas fa-shopping-cart"></i> Adicionar ao Carrinho
                    </button>
                    <button class="btn" onclick="buyNow()">
                        <i class="fas fa-bolt"></i> Comprar Agora
                    </button>
                </section>
            </section>
        </section>

        <section class="reviews-section">
            <header class="reviews-header">
                <h2>Avaliações e Comentários</h2>
                <button class="btn" onclick="scrollToReviewForm()" id="review-btn">
                    <i class="fas fa-star"></i> Avaliar Produto
                </button>
            </header>

            <section class="rating-summary">
                <p class="rating-average" id="average-rating">0.0</p>
                <section>
                    <section class="rating-stars" id="average-stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </section>
                    <p class="rating-count" id="rating-count">0 avaliações</p>
                </section>
            </section>

            <section id="review-form-section" class="review-form" style="display: none;">
                <h3>Deixe sua avaliação</h3>
                <form id="review-form">
                    <section class="form-group">
                        <label>Sua nota:</label>
                        <section class="star-rating" id="star-rating">
                            <i class="fas fa-star star" data-rating="1"></i>
                            <i class="fas fa-star star" data-rating="2"></i>
                            <i class="fas fa-star star" data-rating="3"></i>
                            <i class="fas fa-star star" data-rating="4"></i>
                            <i class="fas fa-star star" data-rating="5"></i>
                        </section>
                    </section>
                    
                    <section class="form-group">
                        <label for="comment">Seu comentário:</label>
                        <textarea id="comment" name="comment" rows="4" placeholder="Conte sua experiência com este produto..." required></textarea>
                    </section>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Enviar Avaliação
                    </button>
                </form>
            </section>

            <section id="login-prompt" class="login-prompt" style="display: none;">
                <p><i class="fas fa-user"></i> Faça login para avaliar este produto</p>
                <a href="/login" class="btn">Fazer Login</a>
            </section>

            <section class="reviews-list" id="reviews-list">
                <p style="text-align: center; color: #666;">Carregando avaliações...</p>
            </section>
        </section>
    </main>

    <script>
        let currentProduct = null;
        let selectedRating = 0;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (productId) {
                loadProduct(productId);
                loadReviews(productId);
            } else {
                window.location.href = '/produtos';
            }

            setupEventListeners();
        });

        async function loadProduct(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`);
                const data = await response.json();
                
                if (data.success && data.product) {
                    currentProduct = data.product;
                    displayProduct(data.product);
                } else {
                    alert('Produto não encontrado');
                    window.location.href = '/produtos';
                }
            } catch (error) {
                console.error('Erro ao carregar produto:', error);
            }
        }

        function displayProduct(product) {
            document.getElementById('product-name').textContent = product.NOME_PROD;
            document.getElementById('product-price').textContent = `R$ ${parseFloat(product.VALOR_UNITARIO).toFixed(2).replace('.', ',')}`;
            document.getElementById('product-description').textContent = product.DESCRICAO_PROD || 'Sem descrição disponível';
            document.getElementById('product-category').textContent = getCategoryName(product.ID_CATEGORIA);
            document.getElementById('product-seller').textContent = product.VENDEDOR_NOME || 'Vendedor';
            document.getElementById('product-stock').textContent = product.QUANTIDADE || '0';
            
            const image = document.getElementById('product-image');
            if (product.IMAGEM_BASE64) {
                image.src = `data:image/jpeg;base64,${product.IMAGEM_BASE64}`;
            } else {
                image.src = 'https://placehold.co/500x500/cccccc/333333?text=Produto';
            }
            
            // Configurar botão de adicionar ao carrinho
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            addToCartBtn.dataset.id = product.ID_PROD;
            addToCartBtn.dataset.nome = product.NOME_PROD;
            addToCartBtn.dataset.preco = product.VALOR_UNITARIO;
            addToCartBtn.dataset.imagem = product.IMAGEM_BASE64 ? `data:image/jpeg;base64,${product.IMAGEM_BASE64}` : '';
        }

        async function loadReviews(productId) {
            try {
                const response = await fetch(`/api/reviews/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayReviews(data.reviews);
                    updateRatingSummary(data.reviews);
                }
            } catch (error) {
                console.error('Erro ao carregar avaliações:', error);
                document.getElementById('reviews-list').innerHTML = '<p style="text-align: center; color: #666;">Erro ao carregar avaliações</p>';
            }
        }

        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviews-list');
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p style="text-align: center; color: #666;">Seja o primeiro a avaliar este produto!</p>';
                return;
            }

            reviewsList.innerHTML = reviews.map(review => `
                <article class="review-item">
                    <header class="review-header">
                        <span class="reviewer-name">${review.NOME_USUARIO}</span>
                        <span class="review-date">${formatDate(review.DATA_AVALIACAO)}</span>
                    </header>
                    <section class="review-rating">
                        ${generateStars(review.NOTA)}
                    </section>
                    <p class="review-comment">${review.COMENTARIO}</p>
                </article>
            `).join('');
        }

        function updateRatingSummary(reviews) {
            if (reviews.length === 0) {
                document.getElementById('average-rating').textContent = '0.0';
                document.getElementById('rating-count').textContent = '0 avaliações';
                return;
            }

            const average = reviews.reduce((sum, review) => sum + review.NOTA, 0) / reviews.length;
            document.getElementById('average-rating').textContent = average.toFixed(1);
            document.getElementById('rating-count').textContent = `${reviews.length} avaliação${reviews.length > 1 ? 'ões' : ''}`;
            
            const starsContainer = document.getElementById('average-stars');
            starsContainer.innerHTML = generateStars(average);
        }

        function setupEventListeners() {
            // Sistema de estrelas
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStarRating();
                });
                
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });

            document.getElementById('star-rating').addEventListener('mouseleave', function() {
                updateStarRating();
            });

            // Form de avaliação
            document.getElementById('review-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitReview();
            });

            // Verificar se usuário está logado
            checkUserLogin();
        }

        function checkUserLogin() {
            const user = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            const reviewFormSection = document.getElementById('review-form-section');
            const loginPrompt = document.getElementById('login-prompt');
            const reviewBtn = document.getElementById('review-btn');

            if (user.id) {
                reviewBtn.onclick = scrollToReviewForm;
            } else {
                reviewBtn.onclick = () => {
                    loginPrompt.style.display = 'block';
                    reviewFormSection.style.display = 'none';
                };
            }
        }

        function scrollToReviewForm() {
            const user = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            if (!user.id) {
                document.getElementById('login-prompt').style.display = 'block';
                return;
            }

            document.getElementById('review-form-section').style.display = 'block';
            document.getElementById('login-prompt').style.display = 'none';
            document.getElementById('review-form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function updateStarRating() {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function highlightStars(rating) {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });
        }

        async function submitReview() {
            if (selectedRating === 0) {
                alert('Por favor, selecione uma nota de 1 a 5 estrelas');
                return;
            }

            const comment = document.getElementById('comment').value.trim();
            if (!comment) {
                alert('Por favor, escreva um comentário');
                return;
            }

            const user = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            if (!user.id) {
                alert('Você precisa estar logado para avaliar');
                return;
            }

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        produto_id: currentProduct.ID_PROD,
                        usuario_id: user.id,
                        nota: selectedRating,
                        comentario: comment
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Avaliação enviada com sucesso!');
                    document.getElementById('review-form').reset();
                    selectedRating = 0;
                    updateStarRating();
                    document.getElementById('review-form-section').style.display = 'none';
                    
                    // Recarregar avaliações
                    loadReviews(currentProduct.ID_PROD);
                } else {
                    alert('Erro ao enviar avaliação: ' + result.message);
                }
            } catch (error) {
                alert('Erro de conexão');
            }
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function getCategoryName(categoryId) {
            const categories = {
                1: 'Artesanato',
                2: 'Decoração',
                3: 'Roupas',
                4: 'Acessórios'
            };
            return categories[categoryId] || 'Categoria';
        }

        function buyNow() {
            // Adicionar ao carrinho e ir direto para checkout
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            addToCartBtn.click();
            setTimeout(() => {
                window.location.href = '/checkout';
            }, 500);
        }
    </script>
</body>
</html>